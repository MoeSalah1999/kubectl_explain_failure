# rules/pvc_crashloop_rules.yaml
- name: PVCNotBound
  category: PersistentVolumeClaim
  phases: ["Pending"]
  requires:
    objects: ["pvc"]
  priority: 10
  match: >
    blocking_pvc
    and blocking_pvc.status.phase == 'Pending'
  explain:
    root_cause: "PVC '{blocking_pvc.metadata.name}' not bound"
    confidence: 0.95
    evidence: ["PVC is Pending"]
    likely_causes:
      - "PVC missing StorageClass"
      - "Insufficient PVs"
      - "PVC selector mismatch"
    suggested_checks:
      - "kubectl get pvc -n {pod.metadata.namespace}"
      - "kubectl describe pvc {blocking_pvc.metadata.name}"

- name: CrashLoopBackOffImagePull
  category: CrashLoopBackOff
  phases: ["Pending", "Running"]
  container_states: ["waiting", "terminated"]
  priority: 50
  match: >
    container_state.reason in ['CrashLoopBackOff','ImagePullBackOff']
    or (
        timeline
        and timeline_has_pattern(timeline, 'BackOff')
      )
  explain:
    root_cause: "Container repeatedly failed to start (CrashLoopBackOff or ImagePullBackOff)"
    confidence: 0.9
    evidence:
      - "Container state indicates repeated failure"
      - "BackOff events observed in timeline"
    likely_causes:
      - "Image not found"
      - "Incorrect image tag"
      - "Crash in entrypoint script"
    suggested_checks:
      - "kubectl describe pod {pod.metadata.name}"
      - "Check container logs with kubectl logs -p"
